{% extends "layout.html" %}
{% import 'forms.html' as forms %}
{% block body %}
{{forms.period_form(form)}}
{{forms.trend_form(t_form)}}
<div class="widget">
<h2>Metametrics</h2>
<table class="keyvalue">
    <tr><th>Number of raw objects</th><td class="numcol">{{raw | decimal}}</td></tr>
    <tr><th>Number of invalid objects</th><td class="numcol">{{invalid | decimal}}</td></tr>
    <tr><th>Number of processed objects</th><td class="numcol">{{(raw-invalid) | decimal}}</td></tr>
</table>
</div>
<div class="widget">
<h2>Planner Metrics</h2>
<table class="keyvalue">
    <tr><th>Workflows Planned</th><td class="numcol">{{planner_stats["plans"] | decimal}}</td></tr>
    <tr><th>Tasks Planned</th><td class="numcol">{{planner_stats["tasks"] | decimal}}</td></tr>
    <tr><th>Jobs Planned</th><td class="numcol">{{planner_stats["jobs"] | decimal}}</td></tr>
    <tr><th>Errors Reported</th><td class="numcol">{{planner_errors | decimal}}</td></tr>
</table>
</div>
<div class="widget">
<h2>DAGMan Metrics</h2>
<table class="keyvalue">
    <tr><th>Workflow Runs</th><td class="numcol">{{dagman_stats["runs"] | decimal}}</td></tr>
    <tr><th>Total Jobs</th><td class="numcol">{{dagman_stats["total_jobs"] | decimal}}</td></tr>
    <tr><th>Jobs Submitted</th><td class="numcol">{{dagman_stats["jobs_run"] | decimal}}</td></tr>
    <tr><th>Jobs Succeeded</th><td class="numcol">{{dagman_stats["succeeded"] | decimal}}</td></tr>
    <tr><th>Jobs Failed</th><td class="numcol">{{dagman_stats["failed"] | decimal}}</td></tr>
    <tr><th>Total Runtime (hrs)</th><td class="numcol">{{dagman_stats["total_runtime"] | float}}</td></tr>
</table>
</div>
<div class="widget">
<h2>Download Metrics</h2>
<table class="keyvalue">
    <tr><th>Number of downloads</th><td class="numcol">{{downloads | decimal}}</td></tr>
</table>
</div>
<div style="clear: both;"></div>
<div class="widget">
<h2>Top Planner Domains</h2>
<table class="top5">
    <tr><th>Domain</th><th>Workflows</th><th>Tasks</th><th>Jobs</th></tr>
    {% for domain in top_domains: %}
    <tr>
        <td>{{domain["domain"] }}</td>
        <td class="right">{{domain["workflows"] | decimal}}</td>
        <td class="right">{{domain["tasks"] | decimal}}</td>
        <td class="right">{{domain["jobs"] | decimal}}</td>
    </tr>
    {% else %}
    <tr><td colspan="4" class="nodata">No Data</td></tr>
    {% endfor %}
</table>
</div>
<div class="widget">
<h2>Top Planner Hosts</h2>
<table class="top5">
    <tr><th>Host</th><th>Workflows</th><th>Tasks</th><th>Jobs</th></tr>
    {% for host in top_hosts: %}
    <tr>
        <td>{{host["hostname"]}}</td>
        <td class="right">{{host["workflows"] | decimal}}</td>
        <td class="right">{{host["tasks"] | decimal}}</td>
        <td class="right">{{host["jobs"] | decimal}}</td>
    </tr>
    {% else %}
    <tr><td colspan="4" class="nodata">No Data</td></tr>
    {% endfor %}
</table>
</div>
<table style="width:100%;">
    <tr>
        <th colspan="2">Workflows Planned By Version</th>
    </tr>
    <tr>
        <td style="width:80%">
            <canvas id="plansTrend" width="1000px" height="500"></canvas>
        </td>
        <td style="width:20%">
            <table id="plansLegend" class="trendLegend" style="width:100%">
                <tr style="text-align: center"><th>Line Color</th><th>Version</th></tr>
            </table>
        </td>
    </tr>
</table>
<hr/>
<table style="width:100%;">
    <tr>
        <th colspan="2">Downloads By Version</th>
    </tr>
    <tr>
        <td style="width:80%">
            <canvas id="downloadsTrend" width="1000px" height="500"></canvas>
        </td>
        <td style="width:20%">
            <table id="downloadsLegend" class="trendLegend" style="width:100%">
                <tr style="text-align: center"><th>Line Color</th><th>Version</th></tr>
            </table>
        </td>
    </tr>
</table>
<script type="text/javascript">

    // Couldn't find a chart tool that automatically generates the colors
    // So we need an array to keep track of them all
    var colors = [
        [255,0,0],
        [255,0,255],
        [255,255,0],
        [0,255,0],
        [0,255,255],
        [0,0,255],
        [62,19,86],
        [255,125,0],
        [125,255,0],
        [0,255,125],
        [0,125,255],
        [125,0,255],
        [255,0,125],
    ];
    // For some reason Javasript Date doesn't give the month in string form, so just use this array
    var monthNames = [ "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December" ];

    function getNewDataSet(label, index) {
        var color = colors[index];
        var colorString = "rgba(" + color[0] + "," + color[1] + "," + color[2] + ",";
        return {
            'label' : label,
            'fillColor' : colorString + "0.2)",
            'strokeColor' : colorString + "1)",
            'pointColor' : colorString + "1)",
            'poinStrokeColor' : "#fff",
            'pointHighlightFill' : "#fff",
            'pointHighlightStroke' : colorString + "1)",
            'data' : []
        };
    }

    function formatTrendData(unformattedData, legendElementID) {
        var formattedData = [];
        var dataSetCount = 0;
        for(var i = 0; i < unformattedData.length; i++) {
            for(var j = 0; j < unformattedData[i].length; j++) {
                var newData = true;
                for(var k = 0; k < formattedData.length; k++) {
                    if(formattedData[k].label == unformattedData[i][j].version) {
                        newData = false;
                        formattedData[k].data.unshift(unformattedData[i][j]['count(*)']);
                    }
                }
                if(newData && unformattedData[i][j].version.search('cvs') == -1 && unformattedData[i][j].version.search('shado') == -1) {
                    var newDataSet = getNewDataSet(unformattedData[i][j].version, dataSetCount++);
                    // Generate html legend
                    $("#"+legendElementID).append("<tr><td><div style='width:20px;height:20px;background-color:" + newDataSet.pointColor + "'></div></td><td>" + newDataSet.label + "</td></p>");
                    formattedData.push(newDataSet);
                    // Fill in zeroes behind data
                    for(var l = 0; l < i; l++) {
                        newDataSet.data.push(0);
                    }
                    newDataSet.data.unshift(unformattedData[i][j]['count(*)']);
                }
                for(var k = 0; k < formattedData.length; k++) {
                    if(formattedData[k].data.length == i) {
                        formattedData[k].data.unshift(0);
                    }
                }
            }
        }
        return formattedData;
    }

    var intervals = {{intervals | tojson | safe}};
    var monthLabels = [];
    for(var i = 0; i < intervals.length-1; i++) {
        // The datetime should come in in seconds and we need to convert to milliseconds
        var intervalDate = new Date(intervals[i] * 1000);
        monthLabels.unshift(monthNames[intervalDate.getMonth()] + " " + intervalDate.getFullYear());
    }


    var plans = {{ plans_trend | tojson | safe}};

    var plansTrend = formatTrendData(plans, "plansLegend");

    var plansChartData = {
        'labels' : monthLabels,
        'datasets' : plansTrend
    };
    var ctx = document.getElementById("plansTrend").getContext("2d");
    var myNewChart = new Chart(ctx).Line(plansChartData);

    var downloads = {{ downloads_trend | tojson | safe}};

    var downloadsTrend = formatTrendData(downloads, "downloadsLegend");

    var downloadsChartData = {
        'labels' : monthLabels,
        'datasets' : downloadsTrend
    };
    ctx = document.getElementById("downloadsTrend").getContext("2d");
    var downloadsChart = new Chart(ctx).Line(downloadsChartData);


</script>
{% endblock %}

